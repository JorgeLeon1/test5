<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Allocate Order (Single)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f7f8fa;--card:#fff;--muted:#6b7280;--text:#111827;
      --accent:#10b981;--accent-2:#3b82f6;--danger:#ef4444;--border:#e5e7eb;
    }
    *{box-sizing:border-box} body{margin:0;padding:24px;background:var(--bg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    h1{margin:0 0 16px} .row{display:flex;gap:16px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;box-shadow:0 1px 6px rgba(0,0,0,.06)}
    .toolbar{display:flex;gap:10px;align-items:center}
    input[type=text]{padding:.65rem .8rem;border:1px solid var(--border);border-radius:8px;min-width:260px}
    button{padding:.6rem 1rem;border:0;border-radius:8px;cursor:pointer;color:#fff;background:var(--accent)}
    button.secondary{background:var(--accent-2)} button.ghost{background:#9ca3af}
    button.warn{background:var(--danger)} button:disabled{opacity:.5;cursor:not-allowed}
    .panel{padding:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.55rem .8rem;border-bottom:1px solid var(--border);text-align:left}
    thead th{background:#f3f4f6;font-weight:600}
    .muted{color:var(--muted)} .right{display:flex;justify-content:flex-end;align-items:center;gap:10px}
    #linesCard{flex:1 1 800px} #orderCard{flex:1 1 380px;max-width:420px}
    .pill{display:inline-block;padding:.1rem .5rem;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:600;font-size:.82rem}
    #log{white-space:pre-wrap;background:#0b1020;color:#cde3ff;border-radius:10px;padding:10px;max-height:180px;overflow:auto;border:1px solid #0f1630}
    .spinner{width:20px;height:20px;border:3px solid #d1d5db;border-top-color:#111827;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>

  <h1>Allocate Order</h1>

  <!-- Controls -->
  <div class="card panel" style="margin-bottom:16px;">
    <div class="toolbar">
      <input id="orderIdInput" type="text" placeholder="Enter Order ID (e.g. 123456)" />
      <button class="secondary" id="loadBtn">Load Order</button>
      <button class="ghost" id="clearBtn">Clear</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div class="row">
    <!-- Order header -->
    <div id="orderCard" class="card panel">
      <h3 style="margin-top:0;">Order</h3>
      <div id="orderMeta" class="muted">No order loaded.</div>
    </div>

    <!-- Lines -->
    <div id="linesCard" class="card panel">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <h3 style="margin:0;">Lines</h3>
        <div class="right">
          <span id="selectedCount" class="muted">0 selected</span>
          <button id="allocBtn" disabled>Allocate in SQL</button>
          <button id="pushBtn" class="secondary" disabled>Push to Extensiv</button>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:36px;"><input type="checkbox" id="selectAll"></th>
            <th>SKU</th>
            <th>Qty</th>
            <th>Qualifier</th>
            <th>Unit</th>
          </tr>
        </thead>
        <tbody id="linesBody">
          <tr><td colspan="5" class="muted">Load an order to see its lines.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- log -->
  <div class="card panel" style="margin-top:16px;">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
      <strong>Activity</strong><div id="busy" style="display:none" class="spinner"></div>
    </div>
    <div id="log"></div>
  </div>

<script>
  // ----- state -----
  let currentOrderId = null;
  let lines = []; // {orderItemId, sku, qty, qualifier, unitName, unitId}
  const SEL = () => Array.from(document.querySelectorAll('.rowchk:checked')).map(c => Number(c.value));

  // ----- el helpers -----
  const el = id => document.getElementById(id);
  const status = (t='') => el('status').textContent = t;
  const log = (msg, obj) => {
    const time = new Date().toLocaleTimeString();
    el('log').textContent += `[${time}] ${msg}` + (obj ? `\n${JSON.stringify(obj,null,2)}` : '') + '\n';
    el('log').scrollTop = el('log').scrollHeight;
  };
  const busy = b => el('busy').style.display = b ? 'inline-block' : 'none';

  // ----- rendering -----
  function renderOrderMeta(order) {
    if (!order) {
      el('orderMeta').textContent = 'No order loaded.';
      return;
    }
    const cust = order.customerName || '(unknown)';
    const ref  = order.referenceNum || '';
    const addr = order.shipTo?.address1 || '';
    el('orderMeta').innerHTML = `
      <div><strong>#${order.orderId}</strong> <span class="pill">${cust}</span></div>
      <div class="muted" style="margin-top:6px">
        Ref: ${ref || '-'}<br>
        ShipTo: ${addr || '-'}
      </div>
    `;
  }

  function renderLines() {
    const tb = el('linesBody');
    if (!lines.length) {
      tb.innerHTML = `<tr><td colspan="5" class="muted">No lines.</td></tr>`;
      el('allocBtn').disabled = true;
      el('pushBtn').disabled  = true;
      el('selectAll').checked = false;
      el('selectedCount').textContent = '0 selected';
      return;
    }
    tb.innerHTML = lines.map(li => `
      <tr>
        <td><input class="rowchk" type="checkbox" value="${li.orderItemId}"></td>
        <td>${li.sku || '-'}</td>
        <td>${li.qty ?? 0}</td>
        <td>${li.qualifier || ''}</td>
        <td>${li.unitName || ''}</td>
      </tr>
    `).join('');
    el('allocBtn').disabled = false;
    el('pushBtn').disabled  = false;
    el('selectAll').checked = false;
    updateSelectedCount();

    document.querySelectorAll('.rowchk').forEach(cb => {
      cb.addEventListener('change', updateSelectedCount);
    });
  }

  function updateSelectedCount() {
    el('selectedCount').textContent = `${SEL().length} selected`;
  }

  // ----- actions -----
  async function loadOrder() {
    const raw = el('orderIdInput').value.trim();
    const id  = Number(raw);
    if (!id) { alert('Enter a numeric Order ID'); return; }

    try {
      busy(true); status('Loading order…');
      const r = await fetch(`/api/single-alloc/order/${id}`);
      const data = await r.json();

      if (!data.ok) {
        log('Load failed', data);
        alert(data.message || 'Failed to load order');
        status('Load failed');
        return;
      }

      currentOrderId = data.order?.orderId || id;
      renderOrderMeta(data.order);

      // normalize rows for table
      lines = (data.lines || []).map(x => ({
        orderItemId: x.OrderItemID ?? x.orderItemId ?? x.id,
        sku:         x.SKU ?? x.ItemID ?? x.sku,
        qty:         x.OrderedQTY ?? x.qty ?? 0,
        qualifier:   x.Qualifier ?? x.qualifier ?? '',
        unitId:      x.UnitID ?? x.unitId ?? null,
        unitName:    x.UnitName ?? x.unitName ?? ''
      }));
      renderLines();

      log(`Order ${currentOrderId} loaded with ${lines.length} lines.`, { order: data.order });
      status('Order ready');
    } catch (e) {
      console.error(e);
      log('Load error', { error: e.message });
      alert('Error loading order');
      status('Error');
    } finally {
      busy(false);
    }
  }

  async function allocateSelected() {
    if (!currentOrderId) return alert('Load an order first');
    const ids = SEL();
    if (!ids.length) return alert('Select at least one line to allocate');

    try {
      busy(true); status('Allocating in SQL…');
      const r = await fetch('/api/single-alloc/allocate', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ orderId: currentOrderId, lineIds: ids })
      });
      const data = await r.json();
      if (!data.ok) {
        log('Allocation failed', data);
        alert(data.message || 'Allocation failed');
        status('Allocation failed');
        return;
      }
      log('Allocation complete', data);
      status('Allocated');
      alert('Allocation complete (saved in SuggAlloc).');
    } catch (e) {
      console.error(e);
      log('Allocation error', { error: e.message });
      alert('Allocation error');
      status('Error');
    } finally { busy(false); }
  }

  async function pushToExtensiv() {
    if (!currentOrderId) return alert('Load an order first');
    if (!confirm(`Push allocations for order #${currentOrderId} to Extensiv?`)) return;

    try {
      busy(true); status('Pushing to Extensiv…');
      const r = await fetch('/api/single-alloc/push', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ orderId: currentOrderId })
      });
      const data = await r.json();
      if (!data.ok) {
        log('Push failed', data);
        alert(data.message || 'Push failed');
        status('Push failed');
        return;
      }
      log('Push complete', data);
      status('Pushed');
      alert('Pushed to Extensiv successfully.');
    } catch (e) {
      console.error(e);
      log('Push error', { error: e.message });
      alert('Push error');
      status('Error');
    } finally { busy(false); }
  }

  function clearAll() {
    currentOrderId = null;
    lines = [];
    el('orderIdInput').value = '';
    renderOrderMeta(null);
    renderLines();
    status('');
    log('Cleared.');
  }

  // ----- events -----
  el('loadBtn').addEventListener('click', loadOrder);
  el('orderIdInput').addEventListener('keydown', e => { if (e.key === 'Enter') loadOrder(); });
  el('allocBtn').addEventListener('click', allocateSelected);
  el('pushBtn').addEventListener('click', pushToExtensiv);
  el('clearBtn').addEventListener('click', clearAll);
  el('selectAll').addEventListener('change', e => {
    document.querySelectorAll('.rowchk').forEach(cb => cb.checked = e.target.checked);
    updateSelectedCount();
  });

  // page starts blank — no auto-load
  renderOrderMeta(null);
  renderLines();
</script>
</body>
</html>
