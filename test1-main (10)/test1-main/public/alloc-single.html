<!-- public/alloc-single.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Single Order Allocation</title>
<style>
  body{font:14px system-ui,Segoe UI,Arial,sans-serif;background:#f8fafc;margin:24px}
  h1{color:#0f766e;margin:.2rem 0 1rem}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:.5rem 0 1rem}
  input[type="number"]{padding:.45rem .6rem;border:1px solid #cbd5e1;border-radius:6px;width:220px}
  button{background:#10b981;color:#fff;border:none;border-radius:6px;padding:.55rem .9rem;cursor:pointer}
  button.secondary{background:#3b82f6}
  button.warn{background:#6b7280}
  table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.05);margin:1rem 0}
  th,td{padding:.5rem .75rem;border-bottom:1px solid #e5e7eb;text-align:left}
  thead{background:#e5e7eb}
  .muted{color:#6b7280}
  .ok{color:#065f46}
  .err{color:#991b1b}
  .stack{display:grid;gap:12px}
</style>
</head>
<body>
  <h1>Single Order Allocation</h1>

  <div class="row">
    <label for="orderId">Order ID</label>
    <input type="number" id="orderId" min="1" placeholder="e.g. 123456"/>
    <button class="secondary" id="fetchBtn">Fetch Order</button>
    <button class="warn" id="pushBtn" disabled>Push Allocations to Extensiv</button>
  </div>

  <div id="status" class="muted"></div>

  <div class="stack">
    <div>
      <h3>Order Lines</h3>
      <div class="muted" id="linesHint">Fetch an order to see lines.</div>
      <table id="linesTbl" style="display:none">
        <thead>
          <tr>
            <th style="width:48px;">Select</th>
            <th>OrderItemID</th><th>OrderID</th><th>SKU</th><th>Qualifier</th><th>Ordered</th>
          </tr>
        </thead>
        <tbody id="linesBody"></tbody>
      </table>
      <button id="allocBtn" disabled>Run SQL Allocation (selected)</button>
    </div>

    <div>
      <h3>Matching Inventory</h3>
      <div class="muted" id="invHint">Inventory for this order’s SKUs appears here.</div>
      <table id="invTbl" style="display:none">
        <thead>
          <tr>
            <th>ItemID</th><th>Qualifier</th><th>ReceiveItemID</th><th>AvailableQTY</th><th>ReceivedQty</th><th>Location</th>
          </tr>
        </thead>
        <tbody id="invBody"></tbody>
      </table>
    </div>

    <div>
      <h3>Current SuggAlloc (this order)</h3>
      <div class="muted" id="saHint">Allocate to see suggestions.</div>
      <table id="saTbl" style="display:none">
        <thead>
          <tr>
            <th>OrderItemID</th><th>ReceiveItemID</th><th>SuggAllocQty</th>
          </tr>
        </thead>
        <tbody id="saBody"></tbody>
      </table>
    </div>
  </div>

<script>
const $ = (id)=>document.getElementById(id);
let currentOrderId = null;
let currentLines = [];

function setStatus(msg, cls='muted'){
  const el = $('status');
  el.className = cls;
  el.textContent = msg || '';
}

function renderLines(lines){
  const tb = $('linesBody');
  if (!lines?.length){
    $('linesTbl').style.display='none';
    $('linesHint').style.display='block';
    $('allocBtn').disabled = true;
    return;
  }
  $('linesHint').style.display='none';
  $('linesTbl').style.display='';
  tb.innerHTML = lines.map(l => `
    <tr>
      <td><input type="checkbox" class="linePick" value="${l.OrderItemID}"></td>
      <td>${l.OrderItemID}</td>
      <td>${l.OrderId}</td>
      <td>${l.SKU || ''}</td>
      <td>${l.Qualifier || ''}</td>
      <td>${l.OrderedQTY}</td>
    </tr>
  `).join('');
  $('allocBtn').disabled = false;
}

function renderInventory(inv){
  const tb = $('invBody');
  if (!inv?.length){
    $('invTbl').style.display='none';
    $('invHint').style.display='block';
    return;
  }
  $('invHint').style.display='none';
  $('invTbl').style.display='';
  tb.innerHTML = inv.map(i => `
    <tr>
      <td>${i.ItemID || ''}</td>
      <td>${i.Qualifier || ''}</td>
      <td>${i.ReceiveItemID}</td>
      <td>${i.AvailableQTY}</td>
      <td>${i.ReceivedQty}</td>
      <td>${i.LocationName || ''}</td>
    </tr>
  `).join('');
}

function renderSuggAlloc(rows){
  const tb = $('saBody');
  if (!rows?.length){
    $('saTbl').style.display='none';
    $('saHint').style.display='block';
    return;
  }
  $('saHint').style.display='none';
  $('saTbl').style.display='';
  tb.innerHTML = rows.map(r => `
    <tr>
      <td>${r.OrderItemID}</td>
      <td>${r.ReceiveItemID}</td>
      <td>${r.SuggAllocQty}</td>
    </tr>
  `).join('');
}

$('fetchBtn').addEventListener('click', async () => {
  try {
    const id = Number($('orderId').value);
    if (!Number.isFinite(id) || id<=0) return alert('Enter a valid Order ID');
    setStatus('Fetching order…');
    const res = await fetch(`/api/single-alloc/order/${id}`);
    const data = await res.json();
    if (!data.ok) throw new Error(data.message || 'Order fetch failed');
    currentOrderId = data.order.orderId;
    currentLines   = data.lines || [];
    renderLines(currentLines);
    renderInventory(data.inventory || []);
    renderSuggAlloc([]); // clear
    setStatus(`Order #${currentOrderId} ready. Upserted ${data.upserts} line(s).`, 'ok');
    $('pushBtn').disabled = false;
  } catch (e) {
    console.error(e);
    setStatus(e.message || 'Failed to fetch order', 'err');
  }
});

$('allocBtn').addEventListener('click', async () => {
  try {
    const selected = [...document.querySelectorAll('.linePick:checked')].map(cb => Number(cb.value));
    if (!selected.length) return alert('Pick at least one line');
    setStatus('Allocating…');
    const res = await fetch('/api/single-alloc/allocate', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ lineIds: selected })
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.message || 'Allocation failed');
    renderSuggAlloc(data.rows || []);
    setStatus(`Allocated ${data.rows?.length || 0} suggestions.`, 'ok');
  } catch (e) {
    console.error(e);
    setStatus(e.message || 'Allocation failed', 'err');
  }
});
<button id="btnBatch">Batch Allocate</button>

<div id="batchPanel" style="display:none; margin:1rem 0; padding:1rem; border:1px solid #ddd; border-radius:8px; background:#fff;">
  <h3>Batch Search</h3>
  <div style="display:grid; grid-template-columns: repeat(3, minmax(200px,1fr)); gap:.5rem;">
    <label>Customer ID <input id="b_customerId" type="number" /></label>
    <label>Status
      <select id="b_status">
        <option value="">Any</option>
        <option value="AWAITINGPICK">Awaiting Pick</option>
        <!-- add more if you map them -->
      </select>
    </label>
    <label>Modified Since <input id="b_modifiedSince" type="datetime-local" /></label>
    <label>Reference contains <input id="b_referenceLike" type="text" /></label>
    <label>Page Size <input id="b_pageSize" type="number" value="100" /></label>
    <label>Max Pages <input id="b_maxPages" type="number" value="3" /></label>
  </div>
  <div style="margin-top:.75rem;">
    <button id="b_search">Search</button>
    <button id="b_allocate">Allocate Selected</button>
    <button id="b_push">Push Selected</button>
  </div>

  <div id="b_results" style="margin-top:1rem;"></div>
</div>

<script>
const $ = (q) => document.querySelector(q);

$("#btnBatch").addEventListener("click", () => {
  const p = $("#batchPanel");
  p.style.display = p.style.display === "none" ? "block" : "none";
});

async function call(url, method='GET') {
  const r = await fetch(url, { method, headers: { 'Content-Type':'application/json' } });
  return r.json();
}
async function callJson(url, body) {
  const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  return r.json();
}

$("#b_search").addEventListener("click", async () => {
  const q = new URLSearchParams();
  const cid = $("#b_customerId").value.trim();
  const st  = $("#b_status").value.trim();
  const ms  = $("#b_modifiedSince").value.trim();
  const ref = $("#b_referenceLike").value.trim();
  const ps  = $("#b_pageSize").value.trim() || "100";
  const mp  = $("#b_maxPages").value.trim() || "3";
  if (cid) q.set('customerId', cid);
  if (st)  q.set('status', st);
  if (ms)  q.set('modifiedSince', new Date(ms).toISOString());
  if (ref) q.set('referenceLike', ref);
  q.set('pageSize', ps);
  q.set('maxPages', mp);

  const data = await call(`/api/batch/search?${q.toString()}`);
  const out = $("#b_results");
  if (!data.ok) {
    out.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    return;
  }
  out.innerHTML = renderBatchResults(data.orders || []);
});

function renderBatchResults(orders) {
  if (!orders.length) return "<p>No orders found.</p>";
  let html = `<table border="1" cellspacing="0" cellpadding="6"><thead>
    <tr>
      <th>Select</th><th>Order ID</th><th>Customer</th><th>Ref</th><th>Lines</th>
    </tr></thead><tbody>`;
  for (const o of orders) {
    html += `<tr>
      <td><input type="checkbox" class="b_order" value="${o.orderId}"></td>
      <td>${o.orderId}</td>
      <td>${o.customerName} (${o.customerId})</td>
      <td>${o.referenceNum || ""}</td>
      <td>${o.lineCount}</td>
    </tr>`;
  }
  html += `</tbody></table>`;
  return html;
}

function selectedOrders() {
  return Array.from(document.querySelectorAll(".b_order:checked"))
    .map(cb => parseInt(cb.value, 10))
    .filter(Boolean);
}

$("#b_allocate").addEventListener("click", async () => {
  const orderIds = selectedOrders();
  if (!orderIds.length) return alert("Select at least one order.");
  const res = await callJson("/api/batch/allocate", { orderIds });
  alert("Allocate result:\n" + JSON.stringify(res, null, 2));
});

$("#b_push").addEventListener("click", async () => {
  const orderIds = selectedOrders();
  if (!orderIds.length) return alert("Select at least one order.");
  const res = await callJson("/api/batch/push", { orderIds });
  alert("Push result:\n" + JSON.stringify(res, null, 2));
});
</script>

$('pushBtn').addEventListener('click', async () => {
  if (!currentOrderId) return alert('Fetch an order first.');
  if (!confirm(`Push SuggAlloc for Order #${currentOrderId} to Extensiv?`)) return;
  try {
    setStatus('Pushing to Extensiv…');
    const res = await fetch('/api/single-alloc/push', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ orderId: currentOrderId })
    });
    const data = await res.json();
    if (!data.ok) throw new Error(`Extensiv responded ${data.status}`);
    setStatus(`Push OK (status ${data.status}).`, 'ok');
  } catch (e) {
    console.error(e);
    setStatus(e.message || 'Push failed', 'err');
  }
});
</script>
</body>
</html>
