<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Allocation – Single & Batch</title>
  <style>
    :root { --green:#10b981; --blue:#3b82f6; --gray:#6b7280; --bg:#f9fafb; --card:#fff; --muted:#6b7280; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:#111827; }
    .wrap { max-width:1200px; margin:24px auto; padding:0 16px; }
    h1 { margin:0 0 16px; font-size:28px; }
    .tabs { display:flex; gap:8px; margin:8px 0 16px; }
    .tab { padding:8px 12px; border-radius:8px; background:#e5e7eb; cursor:pointer; user-select:none; }
    .tab.active { background:#111827; color:#fff; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .card { background:var(--card); border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.05); overflow:hidden; }
    .card h2 { margin:0; padding:14px 16px; border-bottom:1px solid #eef2f7; font-size:16px; }
    .card .body { padding:12px 16px; }
    .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px; align-items:flex-start; }
    button { background:var(--green); color:#fff; border:none; border-radius:8px; padding:8px 12px; cursor:pointer; }
    button.secondary { background:var(--blue); }
    button.muted { background:var(--gray); }
    button:disabled { opacity:.6; cursor:not-allowed; }
    input[type="text"], textarea, select {
      width:100%; max-width:300px; padding:8px 10px; border-radius:8px; border:1px solid #e5e7eb; font:inherit;
    }
    textarea { min-height:72px; resize:vertical; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px 10px; border-bottom:1px solid #eef2f7; text-align:left; }
    thead { background:#f3f4f6; }
    .status { margin-top:10px; font-size:14px; }
    .status.ok { color:#065f46; }
    .status.err { color:#991b1b; }
    .pill { background:#eef2ff; color:#3730a3; padding:2px 8px; border-radius:999px; font-size:12px; }
    .muted { color:var(--muted); }
    .hide { display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Allocation</h1>

    <div class="tabs">
      <div class="tab active" id="tab-single">Single Order</div>
      <div class="tab" id="tab-batch">Batch</div>
    </div>

    <!-- SINGLE ORDER PANEL -->
    <section id="panel-single">
      <div class="card">
        <h2>Find Order</h2>
        <div class="body">
          <div class="toolbar">
            <input id="singleOrderId" type="text" placeholder="Order ID e.g. 208136"/>
            <button class="secondary" id="btnFetchOrder">Fetch Order</button>
            <button class="muted" id="btnPushSingle" disabled>Push Allocations to Extensiv</button>
          </div>
          <div id="singleHeader" class="muted">Enter an order ID and click <b>Fetch Order</b>.</div>
          <div id="singleStatus" class="status"></div>
        </div>
      </div>

      <div class="row" style="margin-top:16px;">
        <div class="card">
          <h2>Order Lines</h2>
          <div class="body">
            <div class="toolbar">
              <button id="btnAllocSelected" disabled>Run SQL Allocation (selected)</button>
              <span class="muted"><span id="selectedCount">0</span> selected</span>
            </div>
            <table>
              <thead>
                <tr>
                  <th style="width:36px;"><input type="checkbox" id="chkAllLines" /></th>
                  <th>OrderItemID</th><th>SKU</th><th>Qty</th><th>Qualifier</th>
                </tr>
              </thead>
              <tbody id="linesTbody">
                <tr><td colspan="5" class="muted">Fetch an order to see lines.</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h2>Current SuggAlloc (this order)</h2>
          <div class="body">
            <div id="suggTally" class="muted">Allocate to see suggestions.</div>
            <table>
              <thead>
                <tr>
                  <th>OrderItemID</th><th>ReceiveItemID</th><th>Qty</th>
                </tr>
              </thead>
              <tbody id="suggBody">
                <tr><td colspan="3" class="muted">No suggestions yet.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h2>Matching Inventory (by SKU)</h2>
        <div class="body">
          <div id="invNote" class="muted">Inventory for this order’s SKUs appears after fetch.</div>
          <table>
            <thead>
              <tr>
                <th>SKU</th><th>ReceiveItemID</th><th>Available</th><th>Received</th><th>Location</th>
              </tr>
            </thead>
            <tbody id="invBody">
              <tr><td colspan="5" class="muted">—</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- BATCH PANEL -->
    <section id="panel-batch" class="hide">
      <div class="card">
        <h2>Batch Load</h2>
        <div class="body">
          <div class="toolbar">
            <div style="display:flex; flex-direction:column; gap:6px; max-width:320px;">
              <label class="muted" for="batchId">Batch ID</label>
              <input id="batchId" type="text" placeholder="e.g. 9673" />
              <button class="secondary" id="btnLoadBatch">Load by Batch ID</button>
            </div>

            <div style="display:flex; flex-direction:column; gap:6px; max-width:520px;">
              <label class="muted" for="batchIds">Specific Order IDs (comma, space, or new lines)</label>
              <textarea id="batchIds" placeholder="e.g. 208136, 208140 208141&#10;208150"></textarea>
              <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <button id="btnLoadIds">Load by Order IDs</button>

                <!-- NEW: push method selector -->
                <label class="muted" for="pushMethod" style="margin-left:8px;">Push method</label>
                <select id="pushMethod" title="Push method" style="max-width:140px;">
                  <option value="auto" selected>Auto</option>
                  <option value="put">PUT</option>
                  <option value="post">POST</option>
                </select>

                <button id="btnBatchAlloc" disabled>Run SQL Allocation (batch)</button>
                <button class="muted" id="btnBatchPush" disabled>Push Batch to Extensiv</button>
              </div>
            </div>
          </div>

          <div id="batchStatusMsg" class="status"></div>

          <table>
            <thead>
              <tr>
                <th style="width:36px;"><input type="checkbox" id="chkBatchAll"></th>
                <th>OrderID</th><th>Customer</th><th>Open Lines</th>
              </tr>
            </thead>
            <tbody id="batchBody">
              <tr><td colspan="4" class="muted">Load a Batch ID or enter Order IDs to see orders.</td></tr>
            </tbody>
          </table>

          <div id="batchAllocSummary" class="status"></div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ---------- tiny helpers ----------
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    async function fetchJSON(url, opts={}) {
      const res = await fetch(url, { headers:{ 'Content-Type':'application/json', 'Accept':'application/json' }, ...opts });
      const txt = await res.text();
      let data;
      try { data = txt ? JSON.parse(txt) : {}; } catch {
        throw new Error(`Unexpected response: ${txt.slice(0,200)}`);
      }
      if (!res.ok || data?.ok === false) {
        throw Object.assign(new Error(data?.message || `HTTP ${res.status}`), { status: res.status, data });
      }
      return data;
    }

    function setStatus(el, msg, kind='') {
      el.className = 'status ' + (kind || '');
      el.textContent = msg || '';
    }

    // ---------- tabs ----------
    const tabSingle = $('#tab-single'), tabBatch = $('#tab-batch');
    const panelSingle = $('#panel-single'), panelBatch = $('#panel-batch');
    tabSingle.addEventListener('click', () => {
      tabSingle.classList.add('active'); tabBatch.classList.remove('active');
      panelSingle.classList.remove('hide'); panelBatch.classList.add('hide');
    });
    tabBatch.addEventListener('click', () => {
      tabBatch.classList.add('active'); tabSingle.classList.remove('active');
      panelBatch.classList.remove('hide'); panelSingle.classList.add('hide');
    });

    // ---------- SINGLE ----------
    let currentOrderId = null;
    let currentLineIds = [];

    const singleStatus = $('#singleStatus');
    const linesTbody = $('#linesTbody');
    const suggBody = $('#suggBody');
    const invBody = $('#invBody');
    const invNote = $('#invNote');
    const chkAllLines = $('#chkAllLines');
    const btnAllocSelected = $('#btnAllocSelected');
    const selectedCount = $('#selectedCount');
    const btnPushSingle = $('#btnPushSingle');

    async function renderOrder(orderId) {
      setStatus(singleStatus, 'Loading order…');
      const data = await fetchJSON(`/api/single-alloc/order/${orderId}`);
      currentOrderId = data.order?.orderId;
      $('#singleHeader').innerHTML = `Order <b>#${data.order?.orderId}</b> — ${data.order?.customerName || ''} <span class="pill">${data.order?.referenceNum || ''}</span>`;
      setStatus(singleStatus, 'Order loaded.', 'ok');

      // render lines
      linesTbody.innerHTML = '';
      currentLineIds = [];
      (data.lines || []).forEach(l => {
        currentLineIds.push(l.OrderItemID);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="ln" data-id="${l.OrderItemID}"/></td>
          <td>${l.OrderItemID}</td>
          <td>${l.SKU || ''}</td>
          <td>${l.OrderedQTY}</td>
          <td>${l.Qualifier || ''}</td>
        `;
        linesTbody.appendChild(tr);
      });
      updateSelectionUI();

      // load inventory (optional endpoint)
      try {
        const skus = [...new Set((data.lines||[]).map(x=>x.SKU).filter(Boolean))];
        const inv = await fetchJSON(`/api/inventory/by-skus`, { method:'POST', body: JSON.stringify({ skus }) });
        invBody.innerHTML = '';
        (inv.items || []).forEach(x => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${x.sku}</td><td>${x.receiveItemId||''}</td><td>${x.available||0}</td><td>${x.received||0}</td><td>${x.location||''}</td>`;
          invBody.appendChild(tr);
        });
        invNote.textContent = '';
      } catch { invBody.innerHTML = '<tr><td colspan="5" class="muted">No inventory endpoint or no data.</td></tr>'; }

      // current suggestions (optional endpoint)
      try {
        const sugg = await fetchJSON(`/api/single-alloc/sugg/${currentOrderId}`);
        suggBody.innerHTML = '';
        if (!sugg.allocations?.length) {
          suggBody.innerHTML = '<tr><td colspan="3" class="muted">No suggestions yet.</td></tr>';
        } else {
          sugg.allocations.forEach(a => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${a.OrderItemID}</td><td>${a.ReceiveItemID}</td><td>${a.SuggAllocQty}</td>`;
            suggBody.appendChild(tr);
          });
        }
      } catch {
        suggBody.innerHTML = '<tr><td colspan="3" class="muted">No suggestion endpoint or no data.</td></tr>';
      }

      btnPushSingle.disabled = false;
    }

    function getSelectedLineIds() {
      return $$('.ln:checked').map(cb => parseInt(cb.dataset.id,10)).filter(Boolean);
    }
    function updateSelectionUI() {
      selectedCount.textContent = getSelectedLineIds().length;
      btnAllocSelected.disabled = !currentOrderId || getSelectedLineIds().length === 0;
      chkAllLines.checked = getSelectedLineIds().length && getSelectedLineIds().length === currentLineIds.length;
    }

    // Single events
    $('#btnFetchOrder').addEventListener('click', async () => {
      try {
        const id = ($('#singleOrderId').value || '').trim();
        if (!/^\d+$/.test(id)) return setStatus(singleStatus, 'Enter a numeric Order ID.', 'err');
        await renderOrder(id);
      } catch (e) {
        console.error(e);
        setStatus(singleStatus, e.message || 'Load failed', 'err');
      }
    });

    chkAllLines.addEventListener('change', () => {
      $$('.ln').forEach(cb => cb.checked = chkAllLines.checked);
      updateSelectionUI();
    });
    linesTbody.addEventListener('change', (e) => {
      if (e.target.classList.contains('ln')) updateSelectionUI();
    });

    btnAllocSelected.addEventListener('click', async () => {
      if (!currentOrderId) return;
      const ids = getSelectedLineIds();
      if (!ids.length) return;
      try {
        setStatus(singleStatus, 'Allocating in SQL…');
        await fetchJSON('/api/single-alloc/allocate', {
          method:'POST',
          body: JSON.stringify({ orderId: currentOrderId, lineIds: ids })
        });
        setStatus(singleStatus, 'Allocation complete.', 'ok');
        const sugg = await fetchJSON(`/api/single-alloc/sugg/${currentOrderId}`);
        suggBody.innerHTML = '';
        if (!sugg.allocations?.length) {
          suggBody.innerHTML = '<tr><td colspan="3" class="muted">No suggestions yet.</td></tr>';
        } else {
          sugg.allocations.forEach(a => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${a.OrderItemID}</td><td>${a.ReceiveItemID}</td><td>${a.SuggAllocQty}</td>`;
            suggBody.appendChild(tr);
          });
        }
      } catch (e) {
        console.error(e);
        setStatus(singleStatus, e.message || 'Allocation failed', 'err');
      }
    });

    $('#btnPushSingle').addEventListener('click', async () => {
      if (!currentOrderId) return alert('Fetch an order first.');
      if (!confirm(`Push SuggAlloc for Order #${currentOrderId} to Extensiv?`)) return;
      try {
        setStatus(singleStatus, 'Pushing to Extensiv…');
        // Use global method selector if present
        const forceMethod = (document.getElementById('pushMethod')?.value || 'auto').toLowerCase();
        const data = await fetchJSON('/api/batch/push', {
          method:'POST',
          body: JSON.stringify({ orderIds: [currentOrderId], forceMethod })
        });
        setStatus(singleStatus, `Push returned: ${data?.results?.[0]?.status ?? 'n/a'}`, data?.results?.[0]?.ok ? 'ok' : 'err');
      } catch (e) {
        console.error(e);
        setStatus(singleStatus, e.data?.message || e.message || 'Push failed', 'err');
      }
    });

    // ---------- BATCH ----------
    const batchBody = $('#batchBody');
    const batchStatusMsg = $('#batchStatusMsg');
    const chkBatchAll = $('#chkBatchAll');
    const btnBatchAlloc = $('#btnBatchAlloc');
    const btnBatchPush = $('#btnBatchPush');
    const btnLoadBatch = $('#btnLoadBatch');
    const btnLoadIds = $('#btnLoadIds');

    function getSelectedOrders() {
      return $$('#batchBody input[type=checkbox]:checked').map(cb => parseInt(cb.dataset.id,10)).filter(Boolean);
    }
    function updateBatchButtons() {
      const any = getSelectedOrders().length > 0;
      btnBatchAlloc.disabled = !any;
      btnBatchPush.disabled = !any;
    }
    function renderBatchTable(orders) {
      batchBody.innerHTML = '';
      if (!orders?.length) {
        batchBody.innerHTML = '<tr><td colspan="4" class="muted">No orders found.</td></tr>';
        return;
      }
      orders.forEach(o => {
        const openLines = (o.lineCount ?? o.openLines ?? '');
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="bo" data-id="${o.orderId}"/></td>
          <td>${o.orderId}</td>
          <td>${o.customerName || ''}</td>
          <td><span class="pill">${openLines}</span></td>
        `;
        batchBody.appendChild(tr);
      });
      chkBatchAll.checked = false;
      updateBatchButtons();
    }

    btnLoadBatch.addEventListener('click', async () => {
      try {
        setStatus(batchStatusMsg, 'Loading batch…');
        const val = ($('#batchId').value || '').trim();
        if (!/^\d+$/.test(val)) {
          setStatus(batchStatusMsg, 'Enter a numeric Batch ID.', 'err'); return;
        }
        const data = await fetchJSON('/api/batch/search-by-batchid', {
          method:'POST', body: JSON.stringify({ batchId: parseInt(val,10), pageSize: 500, maxPages: 10 })
        });
        renderBatchTable(data.orders);
        if ((data.orders?.length || 0) === 0) {
          const diag = (data.diagnostics?.tried || []).map(t => `${t.rql} → ${t.status} (keys: ${t.sampleKeys?.join(", ") || "n/a"})`).join(" | ");
          setStatus(batchStatusMsg, `0 orders. Tried: ${diag}`, 'err');
        } else {
          setStatus(batchStatusMsg, `Loaded ${data.orders?.length || 0} order(s) from batch ${val}. ${data.usedRql ? `RQL: ${data.usedRql}` : ''}`, 'ok');
        }
      } catch (e) {
        console.error(e);
        setStatus(batchStatusMsg, e.message || 'Batch load failed', 'err');
      }
    });

    btnLoadIds.addEventListener('click', async () => {
      try {
        setStatus(batchStatusMsg, 'Loading orders…');
        const raw = ($('#batchIds').value || '');
        const ids = Array.from(new Set(
          raw.split(/[\s,]+/).map(v => v.trim()).filter(v => /^\d+$/.test(v))
        )).map(v => parseInt(v, 10));
        if (!ids.length) {
          setStatus(batchStatusMsg, 'Enter at least one numeric Order ID.', 'err'); return;
        }
        // You can reuse /api/batch/search if you’ve built a by-ids route. For now, assume you have it:
        const data = await fetchJSON('/api/batch/search-by-ids', {
          method:'POST', body: JSON.stringify({ orderIds: ids })
        });
        renderBatchTable(data.orders);
        setStatus(batchStatusMsg, `Loaded ${data.orders?.length || 0} order(s).`, 'ok');
      } catch (e) {
        console.error(e);
        setStatus(batchStatusMsg, e.message || 'Load failed', 'err');
      }
    });

    chkBatchAll.addEventListener('change', () => {
      $$('#batchBody .bo').forEach(cb => cb.checked = chkBatchAll.checked);
      updateBatchButtons();
    });
    batchBody.addEventListener('change', (e) => {
      if (e.target.classList.contains('bo')) updateBatchButtons();
    });

    btnBatchAlloc.addEventListener('click', async () => {
      const orderIds = getSelectedOrders();
      if (!orderIds.length) return;
      if (!confirm(`Run SQL allocation for ${orderIds.length} orders?`)) return;
      try {
        setStatus(batchStatusMsg, 'Allocating (batch)…');
        const data = await fetchJSON('/api/batch/allocate', { method:'POST', body: JSON.stringify({ orderIds }) });

        // Render summary
        const sumDiv = document.getElementById('batchAllocSummary');
        if (Array.isArray(data.summary) && data.summary.length) {
          const byOrder = new Map();
          for (const r of data.summary) {
            const key = r.OrderID;
            if (!byOrder.has(key)) byOrder.set(key, []);
            byOrder.get(key).push(r);
          }
          let html = '<div style="margin-top:8px;"><b>Allocation Summary</b></div>';
          byOrder.forEach((rows, oid) => {
            const totals = rows.reduce((a, r) => {
              a.ordered += (r.OrderedQTY || 0);
              a.allocated += (r.Allocated || 0);
              a.remaining += (r.Remaining || 0);
              return a;
            }, { ordered:0, allocated:0, remaining:0 });

            html += `
              <div style="margin-top:6px;">
                <div><b>Order #${oid}</b></div>
                <table style="width:auto; border-collapse:collapse; margin-top:4px;">
                  <thead>
                    <tr>
                      <th style="padding:4px 8px; border-bottom:1px solid #eef2f7;">SKU</th>
                      <th style="padding:4px 8px; border-bottom:1px solid #eef2f7;">Ordered</th>
                      <th style="padding:4px 8px; border-bottom:1px solid #eef2f7;">Allocated</th>
                      <th style="padding:4px 8px; border-bottom:1px solid #eef2f7;">Remaining</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${rows.map(r => `
                      <tr>
                        <td style="padding:4px 8px; border-bottom:1px solid #f5f6fa;">${r.SKU || ''}</td>
                        <td style="padding:4px 8px; border-bottom:1px solid #f5f6fa;">${r.OrderedQTY ?? ''}</td>
                        <td style="padding:4px 8px; border-bottom:1px solid #f5f6fa;">${r.Allocated ?? 0}</td>
                        <td style="padding:4px 8px; border-bottom:1px solid #f5f6fa;">${r.Remaining ?? ''}</td>
                      </tr>
                    `).join('')}
                    <tr>
                      <td style="padding:6px 8px; font-weight:600;">Totals</td>
                      <td style="padding:6px 8px; font-weight:600;">${totals.ordered}</td>
                      <td style="padding:6px 8px; font-weight:600;">${totals.allocated}</td>
                      <td style="padding:6px 8px; font-weight:600;">${totals.remaining}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            `;
          });
          sumDiv.className = 'status ok';
          sumDiv.innerHTML = html;
        } else {
          const sumDiv = document.getElementById('batchAllocSummary');
          sumDiv.className = 'status';
          sumDiv.textContent = 'No summary rows returned.';
        }

        setStatus(batchStatusMsg, `Allocation complete for ${orderIds.length} orders.`, 'ok');
      } catch (e) {
        console.error(e);
        setStatus(batchStatusMsg, e.message || 'Batch allocation failed', 'err');
      }
    });

    btnBatchPush.addEventListener('click', async () => {
      const orderIds = getSelectedOrders();
      if (!orderIds.length) return;
      if (!confirm(`Push allocations for ${orderIds.length} orders to Extensiv?`)) return;

      try {
        setStatus(batchStatusMsg, 'Pushing (batch)…');

        const forceMethod = (document.getElementById('pushMethod')?.value || 'auto').toLowerCase();
        const data = await fetchJSON('/api/batch/push', {
          method:'POST',
          body: JSON.stringify({ orderIds, forceMethod })
        });

        if (Array.isArray(data.results)) {
          const rows = data.results.map(r => `
            <tr>
              <td>${r.orderId}</td>
              <td>${r.sentAllocations}</td>
              <td>${r.status}${r.triedFallback ? ` (fallback)` : ''}${r.forcedMethod ? ` [${r.forcedMethod}]` : ''}</td>
              <td>${r.ok ? '✅' : '⚠️'}</td>
              <td>${(r.responseSummary || '').replace(/</g,'&lt;')}</td>
            </tr>
          `).join('');
          const html = `
            <div style="margin-top:8px;">
              <b>Push Results</b>
              <table style="width:100%; border-collapse:collapse; margin-top:6px;">
                <thead><tr>
                  <th style="text-align:left; padding:4px 6px;">Order</th>
                  <th style="text-align:left; padding:4px 6px;">Lines Sent</th>
                  <th style="text-align:left; padding:4px 6px;">HTTP</th>
                  <th style="text-align:left; padding:4px 6px;">OK?</th>
                  <th style="text-align:left; padding:4px 6px;">Summary</th>
                </tr></thead>
                <tbody>${rows}</tbody>
              </table>
              ${data.hint ? `<div class="status err" style="margin-top:6px;">${data.hint}</div>` : ''}
            </div>`;
          const sumDiv = document.getElementById('batchAllocSummary');
          sumDiv.className = 'status';
          sumDiv.innerHTML = html;
        }

        setStatus(batchStatusMsg, `Push finished for ${orderIds.length} orders.`, 'ok');
      } catch (e) {
        console.error(e);
        setStatus(batchStatusMsg, e.data?.message || e.message || 'Batch push failed', 'err');
      }
    });
  </script>
</body>
</html>
