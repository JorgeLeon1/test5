<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WestMark Portal ‚Äî KPI Dashboard</title>
  <!-- Chart.js CDN for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --panel: #111827; /* gray-900 */
      --muted: #94a3b8; /* slate-400 */
      --text: #e5e7eb; /* gray-200 */
      --accent: #22d3ee; /* cyan-400 */
      --accent-2: #a78bfa; /* violet-400 */
      --success: #34d399; /* emerald-400 */
      --warn: #f59e0b; /* amber-500 */
      --danger: #f87171; /* red-400 */
      --ring: rgba(34,211,238,.35);
      --card: #0b1220;
      --border: rgba(148,163,184,.15);
    }
    .light {
      --bg: #f8fafc; /* slate-50 */
      --panel: #ffffff; /* white */
      --muted: #475569; /* slate-600 */
      --text: #0f172a; /* slate-900 */
      --accent: #0891b2; /* cyan-700 */
      --accent-2: #6d28d9; /* violet-700 */
      --success: #059669; /* emerald-600 */
      --warn: #b45309; /* amber-700 */
      --danger: #b91c1c; /* red-700 */
      --ring: rgba(8,145,178,.25);
      --card: #ffffff;
      --border: rgba(2,6,23,.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    a { color: inherit; text-decoration: none; }
    .layout { display: grid; grid-template-columns: 280px 1fr; min-height: 100vh; }
    .sidebar { background: var(--panel); border-right: 1px solid var(--border); padding: 24px; position: sticky; top: 0; height: 100vh; }
    .logo { display: flex; align-items: center; gap: 12px; font-weight: 800; letter-spacing: .4px; }
    .logo__dot { width: 12px; height: 12px; border-radius: 50%; background: linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow: 0 0 20px var(--ring); }
    .nav { margin-top: 28px; display: grid; gap: 8px; }
    .nav a { padding: 10px 12px; border-radius: 10px; border: 1px solid transparent; color: var(--muted); display:flex; align-items:center; gap:10px; }
    .nav a.active, .nav a:hover { color: var(--text); border-color: var(--border); background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.08)); }
    .footer-note { position: absolute; bottom: 16px; left: 24px; right: 24px; color: var(--muted); font-size: 12px; }

    .content { display: grid; grid-template-rows: auto 1fr; }
    .topbar { display: flex; align-items: center; justify-content: space-between; padding: 14px 20px; border-bottom: 1px solid var(--border); backdrop-filter: blur(8px); position: sticky; top: 0; background: color-mix(in oklab, var(--bg), transparent 20%); z-index: 10; }
    .topbar .search { display: flex; align-items: center; gap: 8px; background: var(--panel); border: 1px solid var(--border); padding: 8px 12px; border-radius: 12px; width: 420px; max-width: 60vw; }
    .topbar input { background: transparent; border: 0; outline: none; color: var(--text); width: 100%; }
    .topbar .actions { display: flex; gap: 8px; }
    .btn { border: 1px solid var(--border); padding: 8px 12px; border-radius: 10px; background: var(--panel); color: var(--text); cursor: pointer; }
    .btn:hover { box-shadow: 0 0 0 3px var(--ring); }

    .main { padding: 24px; display: grid; gap: 18px; }

    .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    @media (max-width: 1200px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 700px) { .layout { grid-template-columns: 1fr; } .sidebar{ position:relative; height:auto; } .kpi-grid { grid-template-columns: 1fr; } }

    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.15); }
    .card h3 { margin: 0; font-size: 13px; color: var(--muted); font-weight: 600; letter-spacing: .25px; }
    .kpi { display: flex; align-items: baseline; justify-content: space-between; margin-top: 8px; }
    .kpi .value { font-size: 28px; font-weight: 800; letter-spacing: .5px; }
    .kpi .delta { font-size: 12px; padding: 2px 8px; border-radius: 999px; border: 1px solid var(--border); }
    .delta.up { color: var(--success); background: color-mix(in oklab, var(--success), transparent 85%); }
    .delta.down { color: var(--danger); background: color-mix(in oklab, var(--danger), transparent 88%); }

    .panel-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
    @media (max-width: 1200px) { .panel-grid { grid-template-columns: 1fr; } }

    .panel-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 10px; }
    .panel-header h2 { margin: 0; font-size: 16px; letter-spacing: .3px; }

    .filters { display: flex; gap: 8px; flex-wrap: wrap; }
    .select, .input { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; color: var(--text); }

    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); text-align: left; }
    th { color: var(--muted); font-weight: 600; }
    tr:hover td { background: color-mix(in oklab, var(--panel), transparent 85%); }

    .badge { border:1px solid var(--border); border-radius: 999px; padding: 2px 8px; font-size: 12px; }
    .badge.ok { color: var(--success); }
    .badge.warn { color: var(--warn); }
    .badge.err { color: var(--danger); }

    .subtle { color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
<div id="app" class="layout">
  <aside class="sidebar">
    <div class="logo">
      <span class="logo__dot"></span>
      <div>
        <div>WestMark Portal</div>
        <div class="subtle">KPI Dashboards</div>
      </div>
    </div>

    <nav class="nav">
      <a href="#" class="active">üìä Dashboards</a>
      <a href="#">üì¶ Allocations</a>
      <a href="#">üßæ Billing</a>
      <a href="#">üîê Admin</a>
    </nav>

    <div class="footer-note">
      <div>Tip: Use the theme toggle in the top-right.</div>
    </div>
  </aside>

  <section class="content">
    <div class="topbar">
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21L15.8 15.8M18 10.5C18 14.6421 14.6421 18 10.5 18C6.35786 18 3 14.6421 3 10.5C3 6.35786 6.35786 3 10.5 3C14.6421 3 18 6.35786 18 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <input placeholder="Search metrics, orders, clients‚Ä¶" />
      </div>
      <div class="actions">
        <button class="btn" id="refreshBtn">Refresh</button>
        <button class="btn" id="themeToggle">Toggle Theme</button>
      </div>
    </div>

    <main class="main">
      <!-- KPI CARDS -->
      <div class="kpi-grid" id="kpiGrid">
        <div class="card">
          <h3>Orders Allocated (24h)</h3>
          <div class="kpi">
            <div class="value" id="kpiOrders24">‚Äî</div>
            <div class="delta up" id="kpiOrders24Delta">‚Äî</div>
          </div>
        </div>
        <div class="card">
          <h3>Allocation Success Rate</h3>
          <div class="kpi">
            <div class="value" id="kpiSuccess">‚Äî</div>
            <div class="delta up" id="kpiSuccessDelta">‚Äî</div>
          </div>
        </div>
        <div class="card">
          <h3>Avg Allocation Time</h3>
          <div class="kpi">
            <div class="value" id="kpiLatency">‚Äî</div>
            <div class="delta down" id="kpiLatencyDelta">‚Äî</div>
          </div>
        </div>
        <div class="card">
          <h3>Backlog (Unallocated)</h3>
          <div class="kpi">
            <div class="value" id="kpiBacklog">‚Äî</div>
            <div class="delta warn" id="kpiBacklogDelta">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- CHARTS -->
      <div class="panel-grid">
        <div class="card">
          <div class="panel-header">
            <h2>Throughput ‚Äî Orders Allocated by Hour</h2>
            <div class="filters">
              <select class="select" id="timeRange">
                <option value="24h">Last 24 Hours</option>
                <option value="7d">Last 7 Days</option>
                <option value="30d">Last 30 Days</option>
              </select>
              <button class="btn" id="exportPng">Export PNG</button>
            </div>
          </div>
          <canvas id="throughputChart" height="120"></canvas>
        </div>
        <div class="card">
          <div class="panel-header">
            <h2>Allocation Breakdown</h2>
          </div>
          <canvas id="breakdownChart" height="120"></canvas>
          <div class="subtle" style="margin-top:8px">Success / Manual Review / Failed</div>
        </div>
      </div>

      <div class="panel-grid">
        <div class="card">
          <div class="panel-header">
            <h2>Carrier Performance (Last 7 Days)</h2>
          </div>
          <canvas id="carrierChart" height="120"></canvas>
        </div>
        <div class="card">
          <div class="panel-header">
            <h2>Recent Exceptions</h2>
            <div class="filters">
              <input class="input" id="exceptionSearch" placeholder="Search order, batch, message‚Ä¶" />
            </div>
          </div>
          <div style="overflow:auto; max-height:300px">
            <table id="exceptionTable">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Order #</th>
                  <th>Batch</th>
                  <th>Severity</th>
                  <th>Message</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

    </main>
  </section>
</div>

<script>
  // --- THEME TOGGLE (dark/light, persisted) ---
  const root = document.documentElement;
  const themeToggle = document.getElementById('themeToggle');
  const currentTheme = localStorage.getItem('wm-theme') || 'dark';
  if (currentTheme === 'light') {
    root.classList.add('light');
  }
  themeToggle.addEventListener('click', () => {
    root.classList.toggle('light');
    localStorage.setItem('wm-theme', root.classList.contains('light') ? 'light' : 'dark');
  });

  // --- UTILITIES ---
  const fmt = new Intl.NumberFormat();
  const pct = (v) => `${(v*100).toFixed(1)}%`;

  // --- MOCK API (replace with real /api/kpi-metrics) ---
  async function fetchMetrics(range = '24h') {
    // Simulate network delay
    await new Promise(r => setTimeout(r, 250));

    // Create deterministic-but-randomish data per range
    const now = new Date();
    const points = range === '24h' ? 24 : (range === '7d' ? 7 : 30);
    const labels = [];
    const data = [];

    for (let i = points-1; i >= 0; i--) {
      const d = new Date(now);
      if (range === '24h') { d.setHours(d.getHours() - i); labels.push(`${d.getHours()}:00`); }
      if (range === '7d')  { d.setDate(d.getDate() - i);   labels.push(d.toLocaleDateString()); }
      if (range === '30d') { d.setDate(d.getDate() - i);   labels.push(d.toLocaleDateString()); }
      const base = range === '24h' ? 40 : 400; // baseline volume
      data.push(Math.max(5, Math.round(base + (Math.sin(i/2)*base*0.2) + (Math.random()*base*0.15))));
    }

    const orders24 = Math.round(data.slice(-Math.min(24, data.length)).reduce((a,b) => a+b, 0));
    const ordersPrev = Math.round(orders24 * (0.9 + Math.random()*0.2));
    const successRate = 0.92 + Math.random()*0.05; // 92‚Äì97%
    const successPrev = successRate - (Math.random()*0.02 - 0.01);
    const latency = 2.8 + Math.random()*0.8; // minutes
    const latencyPrev = latency + (Math.random()*0.6 - 0.3);
    const backlog = Math.max(0, Math.round(300 + (Math.random()*120 - 60)));
    const backlogPrev = backlog + Math.round(Math.random()*50 - 25);

    const breakdown = {
      success: Math.round(orders24 * successRate),
      manual: Math.round(orders24 * (1-successRate) * 0.6),
      failed: Math.round(orders24 * (1-successRate) * 0.4)
    };

    const carriers = ["UPS", "FedEx", "USPS", "DHL", "OnTrac"];
    const carrierSeries = carriers.map(c => ({
      name: c,
      success: Math.round(90 + Math.random()*10),
      ontime: Math.round(85 + Math.random()*12),
      vol: Math.round(500 + Math.random()*600)
    }));

    const exceptions = Array.from({length: 18}).map(() => ({
      time: new Date(Date.now() - Math.random()*36*3600*1000).toLocaleString(),
      order: `WM${Math.floor(100000 + Math.random()*900000)}`,
      batch: `B${Math.floor(10000 + Math.random()*90000)}`,
      sev: (()=>{ const r = Math.random(); return r<0.15?'High': r<0.55?'Medium':'Low'; })(),
      msg: [
        'Allocation timeout at step: rule-eval',
        'Carrier not available for service level',
        'Missing UCC-128 label data',
        'Inventory short at pick location',
        'Wave constraint conflict',
        'Manual review required: address validation'
      ][Math.floor(Math.random()*6)]
    }));

    return {
      range, labels, data,
      kpis: {
        orders24, ordersPrev, successRate, successPrev, latency, latencyPrev, backlog, backlogPrev
      }, breakdown, carriers: carrierSeries, exceptions
    };
  }

  // --- RENDERERS ---
  const el = id => document.getElementById(id);

  function setKPIs(k) {
    el('kpiOrders24').textContent = fmt.format(k.orders24);
    const d1 = Math.max(-0.99, (k.orders24 - k.ordersPrev) / Math.max(1,k.ordersPrev));
    const ordersDelta = (d1>=0?'+':'') + (d1*100).toFixed(1) + '%';
    const od = el('kpiOrders24Delta');
    od.textContent = ordersDelta; od.classList.toggle('up', d1>=0); od.classList.toggle('down', d1<0);

    el('kpiSuccess').textContent = pct(k.successRate);
    const d2 = k.successRate - k.successPrev;
    const sd = el('kpiSuccessDelta');
    sd.textContent = (d2>=0?'+':'') + (d2*100).toFixed(1) + ' pts'; sd.classList.toggle('up', d2>=0); sd.classList.toggle('down', d2<0);

    el('kpiLatency').textContent = k.latency.toFixed(2) + ' min';
    const d3 = k.latency - k.latencyPrev;
    const ld = el('kpiLatencyDelta');
    ld.textContent = (d3<=0?'‚àí':'+') + Math.abs(d3).toFixed(2) + ' min'; ld.classList.toggle('down', d3<=0); ld.classList.toggle('up', d3>0);

    el('kpiBacklog').textContent = fmt.format(k.backlog);
    const d4 = k.backlog - k.backlogPrev;
    const bd = el('kpiBacklogDelta');
    const sign = d4<=0? '‚àí' : '+';
    bd.textContent = sign + Math.abs(d4);
    bd.classList.toggle('warn', d4===0);
    bd.classList.toggle('up', d4<0);
    bd.classList.toggle('down', d4>0);
  }

  let throughputChart, breakdownChart, carrierChart;

  function renderThroughput(labels, series) {
    const ctx = el('throughputChart');
    throughputChart && throughputChart.destroy();
    throughputChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Orders Allocated',
          data: series,
          tension: 0.35,
          borderWidth: 2,
          fill: true,
          backgroundColor: (context) => {
            const {ctx, chartArea} = context.chart;
            if (!chartArea) return 'transparent';
            const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
            gradient.addColorStop(0, 'rgba(34,211,238,0.35)');
            gradient.addColorStop(1, 'rgba(34,211,238,0.02)');
            return gradient;
          }
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: { mode: 'index', intersect: false }
        },
        interaction: { mode: 'nearest', intersect: false },
        scales: {
          x: { grid: { color: 'rgba(148,163,184,.15)' } },
          y: { grid: { color: 'rgba(148,163,184,.15)' } }
        }
      }
    });
  }

  function renderBreakdown(b) {
    const ctx = el('breakdownChart');
    breakdownChart && breakdownChart.destroy();
    breakdownChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Success', 'Manual Review', 'Failed'],
        datasets: [{
          data: [b.success, b.manual, b.failed],
          borderWidth: 1
        }]
      },
      options: {
        plugins: { legend: { position: 'bottom' } },
        cutout: '60%'
      }
    });
  }

  function renderCarriers(carriers) {
    const ctx = el('carrierChart');
    carrierChart && carrierChart.destroy();
    const labels = carriers.map(c => c.name);
    const success = carriers.map(c => c.success);
    const ontime = carriers.map(c => c.ontime);

    carrierChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Success %', data: success, borderWidth: 1 },
          { label: 'On-Time %', data: ontime, borderWidth: 1 }
        ]
      },
      options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } },
        scales: {
          y: { suggestedMin: 0, suggestedMax: 100, ticks: { callback: v => v + '%' } },
          x: { grid: { display: false } }
        }
      }
    });
  }

  function renderExceptions(rows) {
    const tbody = document.querySelector('#exceptionTable tbody');
    tbody.innerHTML = '';
    rows.forEach(r => {
      const tr = document.createElement('tr');
      const sev = r.sev === 'High' ? 'err' : (r.sev === 'Medium' ? 'warn' : 'ok');
      tr.innerHTML = `
        <td>${r.time}</td>
        <td>${r.order}</td>
        <td>${r.batch}</td>
        <td><span class="badge ${sev}">${r.sev}</span></td>
        <td>${r.msg}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // --- EXPORT ---
  document.getElementById('exportPng').addEventListener('click', () => {
    const url = throughputChart.toBase64Image('image/png', 1);
    const a = document.createElement('a');
    a.href = url; a.download = 'throughput.png'; a.click();
  });

  // --- FILTERS, SEARCH, REFRESH ---
  document.getElementById('refreshBtn').addEventListener('click', () => load());
  document.getElementById('timeRange').addEventListener('change', (e) => load(e.target.value));
  document.getElementById('exceptionSearch').addEventListener('input', (e) => {
    const q = e.target.value.toLowerCase();
    const rows = Array.from(document.querySelectorAll('#exceptionTable tbody tr'));
    rows.forEach(row => {
      row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';
    });
  });

  // --- MAIN LOAD ---
  async function load(range = document.getElementById('timeRange').value) {
    const res = await fetchMetrics(range);
    setKPIs(res.kpis);
    renderThroughput(res.labels, res.data);
    renderBreakdown(res.breakdown);
    renderCarriers(res.carriers);
    renderExceptions(res.exceptions);
  }

  load();
</script>
</body>
</html>
