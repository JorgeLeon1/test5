<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>WestMark Portal ‚Äî KPI Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22d3ee; --accent-2:#a78bfa; --success:#34d399; --warn:#f59e0b; --danger:#f87171;
      --ring:rgba(34,211,238,.35); --card:#0b1220; --border:rgba(148,163,184,.15);
    }
    .light {
      --bg:#f8fafc; --panel:#fff; --muted:#475569; --text:#0f172a;
      --accent:#0891b2; --accent-2:#6d28d9; --success:#059669; --warn:#b45309; --danger:#b91c1c;
      --ring:rgba(8,145,178,.25); --card:#fff; --border:rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    a{color:inherit;text-decoration:none}
    .layout{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
    .sidebar{background:var(--panel);border-right:1px solid var(--border);padding:24px;position:sticky;top:0;height:100vh}
    .logo{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.4px}
    .logo__dot{width:12px;height:12px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:0 0 20px var(--ring)}
    .nav{margin-top:28px;display:grid;gap:8px}
    .nav a{padding:10px 12px;border-radius:10px;border:1px solid transparent;color:var(--muted);display:flex;align-items:center;gap:10px}
    .nav a.active,.nav a:hover{color:var(--text);border-color:var(--border);background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.08))}
    .footer-note{position:absolute;bottom:16px;left:24px;right:24px;color:var(--muted);font-size:12px}

    .content{display:grid;grid-template-rows:auto 1fr}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border);backdrop-filter:blur(8px);position:sticky;top:0;background:color-mix(in oklab,var(--bg),transparent 20%);z-index:10}
    .topbar .search{display:flex;align-items:center;gap:8px;background:var(--panel);border:1px solid var(--border);padding:8px 12px;border-radius:12px;width:420px;max-width:60vw}
    .topbar input{background:transparent;border:0;outline:none;color:var(--text);width:100%}
    .topbar .actions{display:flex;gap:8px}
    .btn{border:1px solid var(--border);padding:8px 12px;border-radius:10px;background:var(--panel);color:var(--text);cursor:pointer}
    .btn:hover{box-shadow:0 0 0 3px var(--ring)}

    .main{padding:24px;display:grid;gap:18px}
    .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
    @media (max-width:1200px){.kpi-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:700px){.layout{grid-template-columns:1fr}.sidebar{position:relative;height:auto}.kpi-grid{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .card h3{margin:0;font-size:13px;color:var(--muted);font-weight:600;letter-spacing:.25px}
    .kpi{display:flex;align-items:baseline;justify-content:space-between;margin-top:8px}
    .kpi .value{font-size:28px;font-weight:800;letter-spacing:.5px}
    .kpi .delta{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--border)}
    .delta.up{color:var(--success);background:color-mix(in oklab,var(--success),transparent 85%)}
    .delta.down{color:var(--danger);background:color-mix(in oklab,var(--danger),transparent 88%)}

    .panel-grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
    @media (max-width:1200px){.panel-grid{grid-template-columns:1fr}}
    .panel-header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:10px}
    .panel-header h2{margin:0;font-size:16px;letter-spacing:.3px}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .select,.input{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:8px 10px;color:var(--text)}

    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px 12px;border-bottom:1px solid var(--border);text-align:left}
    th{color:var(--muted);font-weight:600}
    tr:hover td{background:color-mix(in oklab,var(--panel),transparent 85%)}
    .badge{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px}
    .subtle{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
<div id="app" class="layout">
  <aside class="sidebar">
    <div class="logo">
      <span class="logo__dot"></span>
      <div>
        <div>WestMark Portal</div>
        <div class="subtle">KPI Dashboards</div>
      </div>
    </div>

    <nav class="nav">
      <a href="/kpi.html" class="active">üìä Dashboards</a>
      <a href="/alloc-single">üì¶ Allocations</a>
      <a href="/reports">üßæ Reports</a>
      <a href="/account">üîê Account</a>
    </nav>

    <div class="footer-note">
      <div>Tip: Use the theme toggle in the top-right.</div>
    </div>
  </aside>

  <section class="content">
    <div class="topbar">
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M21 21L15.8 15.8M18 10.5C18 14.6421 14.6421 18 10.5 18C6.35786 18 3 14.6421 3 10.5C3 6.35786 6.35786 3 10.5 3C14.6421 3 18 6.35786 18 10.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <input id="searchBox" placeholder="Search orders (order #, account, warehouse)‚Ä¶"/>
      </div>
      <div class="actions">
        <button class="btn" id="refreshBtn">Refresh</button>
        <button class="btn" id="themeToggle">Toggle Theme</button>
      </div>
    </div>

    <main class="main">
      <!-- KPI CARDS (live from Extensiv) -->
      <div class="kpi-grid">
        <div class="card">
          <h3>Open Orders (Live)</h3>
          <div class="kpi">
            <div class="value" id="kpiOpen">‚Äî</div>
            <div class="delta up" id="kpiOpenDelta">‚Äî</div>
          </div>
        </div>
        <div class="card">
          <h3>New in Last 24h</h3>
          <div class="kpi">
            <div class="value" id="kpiNew24">‚Äî</div>
            <div class="delta up" id="kpiNewDelta">‚Äî</div>
          </div>
        </div>
        <div class="card">
          <h3>Avg Order Age</h3>
          <div class="kpi">
            <div class="value" id="kpiAvgAge">‚Äî</div>
            <div class="delta down" id="kpiAvgAgeDelta">‚Äî</div>
          </div>
        </div>
        <div class="card">
          <h3>Oldest Order Age</h3>
          <div class="kpi">
            <div class="value" id="kpiOldest">‚Äî</div>
            <div class="delta warn" id="kpiOldestDelta">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- CHARTS -->
      <div class="panel-grid">
        <div class="card">
          <div class="panel-header">
            <h2>Open-Order Throughput (Created)</h2>
            <div class="filters">
              <select class="select" id="timeRange">
                <option value="24h">Last 24 Hours</option>
                <option value="7d">Last 7 Days</option>
                <option value="30d">Last 30 Days</option>
              </select>
              <button class="btn" id="exportPng">Export PNG</button>
            </div>
          </div>
          <canvas id="throughputChart" height="120"></canvas>
        </div>
        <div class="card">
          <div class="panel-header">
            <h2>Open Orders by Warehouse</h2>
          </div>
          <canvas id="breakdownChart" height="120"></canvas>
          <div class="subtle" style="margin-top:8px">Count of open orders grouped by warehouse.</div>
        </div>
      </div>

      <!-- LIVE OPEN ORDERS TABLE -->
      <div class="card">
        <div class="panel-header">
          <h2>Live Open Orders</h2>
          <div class="filters">
            <button class="btn" id="exportCsv">Export CSV</button>
          </div>
        </div>
        <div style="overflow:auto; max-height:420px">
          <table id="ordersTable">
            <thead>
              <tr>
                <th>Order #</th>
                <th>Account</th>
                <th>Warehouse</th>
                <th>Created</th>
                <th>Age</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </main>
  </section>
</div>

<script>
  // === THEME TOGGLE ===
  const root=document.documentElement, themeToggle=document.getElementById('themeToggle');
  const currentTheme=localStorage.getItem('wm-theme')||'dark';
  if(currentTheme==='light') root.classList.add('light');
  themeToggle.addEventListener('click',()=>{root.classList.toggle('light');localStorage.setItem('wm-theme',root.classList.contains('light')?'light':'dark');});

  // === HELPERS ===
  const fmtInt = new Intl.NumberFormat();
  const fmtDate = (d)=> new Date(d).toLocaleString();
  const MS_HOUR = 3600_000, MS_DAY = 86_400_000;

  const el = id => document.getElementById(id);
  const pathRangeToHours = (range)=> range==='24h'?24 : range==='7d'? 7*24 : 30*24;

  // Map Extensiv order -> normalized shape
  function mapOrder(o){
    // Adjust these field names if your API differs:
    const orderNumber = o.orderNumber || o.OrderNumber || o.orderNo || o.externalId;
    const account     = o.account || o.Customer || o.client || o.accountName || '';
    const warehouse   = o.warehouse || o.Warehouse || o.facility || '';
    const createdAt   = o.createdAt || o.CreatedAt || o.created_at || o.created || o.CreateDate;
    return { orderNumber, account, warehouse, createdAt: createdAt ? new Date(createdAt) : null };
  }

  // === BACKEND CALL (expects /api/extensiv/open-orders?range=24h|7d|30d ) ===
  async function fetchOpenOrders(range='24h'){
    const res = await fetch(`/api/extensiv/open-orders?range=${encodeURIComponent(range)}`, { headers:{'Accept':'application/json'} });
    if(!res.ok) throw new Error(`API ${res.status}`);
    const json = await res.json();
    const orders = (json.orders||[]).map(mapOrder).filter(o => o.createdAt instanceof Date && !isNaN(o.createdAt));
    return orders;
  }

  // === KPI CALCS ===
  function ageStr(ms){
    const d = Math.floor(ms/MS_DAY);
    const h = Math.floor((ms%MS_DAY)/MS_HOUR);
    if(d>0) return `${d}d ${h}h`;
    if(h>0) return `${h}h`;
    const m = Math.max(0, Math.floor((ms%MS_HOUR)/60000));
    return `${m}m`;
  }

  function setKpis(orders){
    const now = Date.now();
    const ages = orders.map(o => now - o.createdAt.getTime()).filter(n => n>=0);
    const openCount = orders.length;
    const new24 = orders.filter(o => (now - o.createdAt.getTime()) <= MS_DAY).length;
    const avgAgeMs = ages.length ? ages.reduce((a,b)=>a+b,0)/ages.length : 0;
    const oldestMs = ages.length ? Math.max(...ages) : 0;

    el('kpiOpen').textContent = fmtInt.format(openCount);
    el('kpiNew24').textContent = fmtInt.format(new24);
    el('kpiAvgAge').textContent = ages.length ? ageStr(avgAgeMs) : '‚Äî';
    el('kpiOldest').textContent = ages.length ? ageStr(oldestMs) : '‚Äî';

    // Simple deltas (vs. previous fetch); store last values
    const last = window.__kpi_last || {};
    const delta = (curr, prev)=> prev==null ? '‚Äî' : ((curr-prev)>=0?'+':'') + (curr-prev);
    el('kpiOpenDelta').textContent = delta(openCount, last.open);
    el('kpiNewDelta').textContent = delta(new24, last.new24);
    el('kpiAvgAgeDelta').textContent = '‚Äî';
    el('kpiOldestDelta').textContent = '‚Äî';
    window.__kpi_last = { open: openCount, new24 };
  }

  // === CHARTS ===
  let throughputChart, breakdownChart;

  function groupByPeriod(orders, range){
    const hours = pathRangeToHours(range);
    const now = Date.now();
    // Build bins by hour or day depending on range
    const by = range==='24h' ? 'hour' : 'day';
    const labels = [];
    const map = new Map();

    for(let i=hours-1;i>=0;i--){
      const d = new Date(now - i*MS_HOUR);
      const key = by==='hour'
        ? `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()} ${d.getHours()}:00`
        : `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
      labels.push(by==='hour' ? d.getHours()+':00' : d.toLocaleDateString());
      map.set(key,0);
    }

    orders.forEach(o=>{
      const d = o.createdAt;
      const key = (by==='hour')
        ? `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()} ${d.getHours()}:00`
        : `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
      if(map.has(key)) map.set(key, map.get(key)+1);
    });

    const data = Array.from(map.values());
    return { labels, data };
  }

  function renderThroughput(range, orders){
    const {labels, data} = groupByPeriod(orders, range);
    throughputChart && throughputChart.destroy();
    throughputChart = new Chart(el('throughputChart'), {
      type:'line',
      data:{ labels, datasets:[{ label:'Orders Created', data, tension:.35, borderWidth:2, fill:true,
        backgroundColor:(c)=>{ const {ctx, chartArea}=c.chart; if(!chartArea) return 'transparent';
          const g=ctx.createLinearGradient(0,chartArea.top,0,chartArea.bottom);
          g.addColorStop(0,'rgba(34,211,238,0.35)'); g.addColorStop(1,'rgba(34,211,238,0.02)'); return g; } }]},
      options:{ responsive:true, plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false}},
        interaction:{mode:'nearest',intersect:false},
        scales:{ x:{ grid:{color:'rgba(148,163,184,.15)'}}, y:{ beginAtZero:true, grid:{color:'rgba(148,163,184,.15)'} } } }
    });
  }

  function renderWarehouseBreakdown(orders){
    const counts = {};
    orders.forEach(o=> { counts[o.warehouse||'‚Äî'] = (counts[o.warehouse||'‚Äî']||0) + 1; });
    const labels = Object.keys(counts);
    const data   = Object.values(counts);
    breakdownChart && breakdownChart.destroy();
    breakdownChart = new Chart(el('breakdownChart'), {
      type:'bar',
      data:{ labels, datasets:[{ label:'Open Orders', data, borderWidth:1 }]},
      options:{ responsive:true, plugins:{ legend:{position:'bottom'} },
        scales:{ y:{ beginAtZero:true }, x:{ grid:{display:false} } } }
    });
  }

  // === TABLE ===
  function renderTable(orders){
    const q = el('searchBox').value.trim().toLowerCase();
    const tbody = document.querySelector('#ordersTable tbody'); tbody.innerHTML='';
    const now = Date.now();
    orders
      .filter(o=>{
        const s = `${o.orderNumber} ${o.account} ${o.warehouse}`.toLowerCase();
        return !q || s.includes(q);
      })
      .sort((a,b)=> b.createdAt - a.createdAt)
      .forEach(o=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${o.orderNumber||'‚Äî'}</td>
          <td>${o.account||'‚Äî'}</td>
          <td>${o.warehouse||'‚Äî'}</td>
          <td>${fmtDate(o.createdAt)}</td>
          <td>${ageStr(now - o.createdAt.getTime())}</td>
        `;
        tbody.appendChild(tr);
      });
  }

  // === EXPORTS ===
  el('exportPng').addEventListener('click',()=>{
    if(!throughputChart) return;
    const url = throughputChart.toBase64Image('image/png',1);
    const a = document.createElement('a'); a.href=url; a.download='open-orders-throughput.png'; a.click();
  });

  el('exportCsv').addEventListener('click', ()=>{
    const rows = [['Order #','Account','Warehouse','Created','Age']];
    const now = Date.now();
    (window.__orders_cache||[]).forEach(o=>{
      rows.push([o.orderNumber||'', o.account||'', o.warehouse||'', o.createdAt.toISOString(), ageStr(now - o.createdAt.getTime())]);
    });
    const csv = rows.map(r=> r.map(x=> `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='open-orders.csv'; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  });

  // === LOAD / REFRESH ===
  el('refreshBtn').addEventListener('click',()=> load());
  el('timeRange').addEventListener('change',()=> load());
  el('searchBox').addEventListener('input',()=> renderTable(window.__orders_cache||[]));

  async function load(){
    const range = el('timeRange').value;
    try{
      const orders = await fetchOpenOrders(range);
      window.__orders_cache = orders;
      setKpis(orders);
      renderThroughput(range, orders);
      renderWarehouseBreakdown(orders);
      renderTable(orders);
    }catch(err){
      console.error('Failed to load open orders:', err);
      // Minimal graceful fallback
      setKpis([]); renderThroughput('24h', []); renderWarehouseBreakdown([]); renderTable([]);
    }
  }

  load();
</script>
</body>
</html>
